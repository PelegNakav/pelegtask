pipeline {
    agent any

    parameters {
        string(
            name: 'BUILD_NUMBER',
            defaultValue: '',
            description: 'Optional: CI build number or image tag to deploy'
        )
    }

    environment {
        DOCKER_IMAGE = 'pelegnakav/pelegtest'
        DOCKER_TAG = "${params.BUILD_NUMBER ?: 'latest'}"
        CONTAINER_NAME = 'demo-app-test'
        TEST_PORT = '8080'
    }

    stages {
        stage('Pull Docker Image') {
            steps {
                echo "Pulling image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                sh '''
                    docker pull ${DOCKER_IMAGE}:${DOCKER_TAG}
                '''
            }
        }

        stage('Deploy to Test Environment') {
            steps {
                echo "Deploying container ${CONTAINER_NAME}..."
                sh '''
                    docker rm -f ${CONTAINER_NAME} || true
                    docker run -d --name ${CONTAINER_NAME} -p ${TEST_PORT}:8080 ${DOCKER_IMAGE}:${DOCKER_TAG}
                '''
            }
        }

        stage('Post-Deployment Tests') {
            steps {
                echo "Running health check on http://localhost:${TEST_PORT} ..."
                sh '''
                    sleep 5
                    if curl -f http://localhost:${TEST_PORT}; then
                        echo "Health check passed!"
                    else
                        echo "Health check failed!"
                        exit 1
                    fi
                '''
            }
        }
    }

    post {
        success {
            echo "Deployment successful for ${DOCKER_IMAGE}:${DOCKER_TAG}"
        }
        failure {
            echo "Deployment failed for ${DOCKER_IMAGE}:${DOCKER_TAG}"
        }
    }
