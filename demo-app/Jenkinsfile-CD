pipeline {
    agent any

    parameters {
        string(name: 'BUILD_NUMBER', defaultValue: '17', description: 'Optional: CI build number to deploy (if empty, uses current build number)')
    }

    environment {
        DOCKER_IMAGE = 'pelegnakav/pelegtest'
        DOCKER_TAG = "${params.BUILD_NUMBER}" // expected to match the tag pushed by CI
        HELM_RELEASE = 'demo-app'
        NAMESPACE = 'demo'
    }
pipeline {
    agent any

    parameters {
        string(name: 'BUILD_NUMBER', defaultValue: '', description: 'Optional: CI build number / image tag to deploy')
    }

    environment {
        DOCKER_IMAGE = 'pelegnakav/pelegtest'
        DOCKER_TAG = "${params.BUILD_NUMBER}"
        CONTAINER_NAME = 'demo-app-test'
        TEST_PORT = '8080'
    }

    stages {
        stage('Resolve Tag') {
            steps {
                script {
                    if (!env.DOCKER_TAG) {
                        env.DOCKER_TAG = env.BUILD_NUMBER ?: 'latest'
                    }
                    echo "Using image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                }
            }
        }

        stage('Pull Docker Image') {
            steps {
                script {
                    // Pull image from Docker Hub using Jenkins credential 'dockerhub'
                    docker.withRegistry('', 'dockerhub') {
                        docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}").pull()
                    }
                }
            }
        }

        stage('Deploy to Test (docker run)') {
            steps {
                script {
                    sh """
                        # Stop & remove any previous test container
                        if docker ps -a --format '{{.Names}}' | grep -w ${CONTAINER_NAME} >/dev/null 2>&1; then
                          docker rm -f ${CONTAINER_NAME} || true
                        fi

                        # Run the test container
                        docker run -d --name ${CONTAINER_NAME} -p ${TEST_PORT}:8080 ${DOCKER_IMAGE}:${DOCKER_TAG}
                    """
                }
            }
        }

        stage('Post-Deployment Tests') {
            steps {
                script {
                    sh """
                        set -e
                        echo 'Waiting for service to respond on port ${TEST_PORT}...'
                        # Try for up to 60 seconds
                        for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30; do
                          if curl -sS http://127.0.0.1:${TEST_PORT}/ | grep -q 'Hello'; then
                            echo 'Smoke test passed.'
                            exit 0
                          fi
                          sleep 2
                        done

                        echo 'Smoke test failed - dumping container logs'
                        docker logs ${CONTAINER_NAME} || true
                        exit 1
                    """
                }
            }
        }
    }

    post {
        always {
            // Cleanup test container
            sh "docker rm -f ${CONTAINER_NAME} || true"
        }
        success {
            echo "CD pipeline succeeded: ${DOCKER_IMAGE}:${DOCKER_TAG} tested locally"
        }
        failure {
            echo 'CD pipeline failed - see logs above.'
        }
    }
}
                            echo 'Cluster smoke test passed.'
                        else
                            echo 'Cluster smoke test failed. Dumping response:' >&2
                            cat /tmp/cluster-response || true
                            exit 1
                        fi
                    """
                }
            }
        }
    }

    post {
        success {
            echo "CD pipeline completed: ${DOCKER_IMAGE}:${DOCKER_TAG} deployed to ${NAMESPACE}/${HELM_RELEASE}"
        }
        failure {
            echo 'Deployment failed, attempting rollback...'
            script {
                sh "helm rollback ${HELM_RELEASE} -n ${NAMESPACE} || true"
            }
        }
    }
}